<!DOCTYPE html>
<html><head>
	<meta charset='utf-8'>
	<title>Rephinez</title>
	<style>
		* { font-family: sans-serif }
		input { width:3em; font-family:monospace }
		#output { width:80%; margin:1em auto }
		thead th { opacity: 0.6; text-align:left }
		tbody th { font-weight:normal; text-align:left; padding-right:0.5em }
		td.weight { text-align:center }
		.score, .strain { text-align:right }
		thead .strain { font-weight:bold }
		#output table { border-collapse:collapse; margin:0 auto }
		#output td { border:1px solid #999; background:#fafafa; padding:0.2em 0.6em }
		#stats { font-family:monospace; white-space:pre; margin:1em auto; width:80% }
	</style>
</head><body>
<h1>Rephinez</h1>
<label id="scenarios">Scenario: <select></select></label>
<fieldset id="yardsticks">
	<legend>Yardsticks</legend>
	<table><thead><tr>
		<th>Measure</th>
		<th class='score'>Score</th>
		<th>× Weight =</th>
		<th id='total-strain' class='strain'>-</th>
	</thead><tbody>
	</tbody></table>
	<button id="restart">↺</button><button id="go">▶</button>
</fieldset>
<div id="output"></div>
<div id="stats"></div>
<script>
const scenarios = document.querySelector('#scenarios select')
const yardsticks = document.querySelector('#yardsticks tbody')
scenarios.addEventListener('focus', checkScenarios, false)
scenarios.addEventListener('change', switchScenario, false)
go.addEventListener('click', start, false)
restart.addEventListener('click', reset, false)
yardsticks.addEventListener('input', updateWeight, false)
checkScenarios();

let lastHTML, lastStats
let scenarioName
async function checkScenarios() {
	const response = await fetch('/scenarios')
	const json = await response.json()
	let update = false
	json.forEach((s,i) => {
		if (!scenarios.options[i] || scenarios.options[i].text!=s) update = true
	})
	if (update) {
		const val = scenarios.value
		scenarios.options.length = 0
		json.forEach(s => scenarios.add(new Option(s)))
		scenarios.value = val
	}
}

async function switchScenario() {
	yardsticks.innerHTML = ''
	stats.innerHTML = output.innerHTML = lastHTML = ''
	scenarioName = scenarios.value
	if (scenarioName) {
		const response = await fetch(`/reset/${scenarioName}`)
		const json = await response.json()
		showYardsticks(json.yardsticks)
		update(json)
	}
}

function showYardsticks(sticklist) {
	yardsticks.innerHTML = Object.entries(sticklist).map(([name,score]) => `<tr>
		<th>${name}</th>
		<td data-yardstick='${name}' class='score'></td>
		<td class='weight'><input data-yardstick='${name}' class='weight' value='${score}'></td>
		<td data-yardstick='${name}' class='strain'></td>
	</tr>`).join('')
}

async function reset() {
	const response = await fetch(`/reset/${scenarioName}`)
	const json = await response.json()

	update(json)
}

async function updateWeight(evt) {
	const stickName = evt.target.dataset.yardstick
	const response = await fetch(`/weight/${scenarioName}/${stickName}/${evt.target.value || 0}`)
	const json = await response.json()
	update(json)
}

function start() {
	const inputs = Array.from(document.querySelectorAll('input, select, button'))
	inputs.forEach(el => el.disabled=true)
	poke(`/start/${scenarioName}`, 'POST')
	let peeker = setInterval(peek, 200)
	async function peek() {
		const response = await fetch(`/peek`)
		const json = await response.json()
		if (json.totalProgress>=1) {
			clearInterval(peeker)
			inputs.forEach(el => el.disabled=false)
		} else {
			console.log(`Round ${json.roundNumber}`, `${(json.totalProgress*100).toFixed(1)}%`, `${(json.currentTemp||0).toFixed(1)}°`, (json.currentScore ? json.currentScore.score : -1).toFixed(2), (json.bestScore ? json.bestScore.score : -1).toFixed(2))
		}
		update(json)
	}
}

function update(json) {
	if (json.bestScore) {
		Object.entries(json.bestScore.scores).forEach(([name,score]) => {
			document.querySelector(`[data-yardstick="${name}"].score`).innerHTML = score.raw.toFixed(2)
			document.querySelector(`[data-yardstick="${name}"].strain`).innerHTML = score.weighted.toFixed(2)
		})
		document.querySelector('#total-strain').innerHTML = json.bestScore.score.toFixed(2)
		const longestStatName = Math.max.apply(Math, Object.keys(json.bestScore.stats).map(s => s.length))
		stats.innerHTML = Object.entries(json.bestScore.stats).map(([name,str]) => `${name.padEnd(longestStatName, ' ')} : ${str}`).join('\n')
	}
	if (json.yardsticks) {
		Object.entries(json.yardsticks).forEach(([name,weight]) => {
			const inp = document.querySelector(`[data-yardstick="${name}"].weight`)
			if (inp && document.activeElement!==inp) inp.value = weight
		})
	}
	if (json.bestStateHTML && lastHTML!=json.bestStateHTML) output.innerHTML = lastHTML = json.bestStateHTML
}

function poke(url, method='GET') {
	const xhr = new XMLHttpRequest
	xhr.open(method, url, true)
	xhr.send()
}
</script>
</body></html>